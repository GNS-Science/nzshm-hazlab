import csv
from typing import List, Tuple
from pathlib import Path
from collections import namedtuple

from nzshm_common.location.code_location import CodedLocation
from nzshm_common.grids.region_grid import load_grid
from nzshm_common.location.location import location_by_id, LOCATION_LISTS

def transpower_locs() -> List[Tuple[float, float]]:

    return [
        (-44.2511114772, 170.799858272),
        (-43.5385280381, 172.603100709),
        (-36.7388439935, 174.689089064),
        (-42.948244399, 171.567956091),
        (-38.6164425189, 176.142886043),
        (-41.6652838293, 173.203497909),
        (-38.0716797943, 175.642699731),
        (-43.9419307374, 171.800589632),
        (-43.2626786177, 172.623614354),
        (-38.3932714961, 176.023553641),
        (-44.6580044245, 170.354125621),
        (-46.2279074479, 169.771804195),
        (-46.2250295849, 168.842227893),
        (-44.5697503994, 170.198845189),
        (-41.4983392253, 173.931920322),
        (-37.1881846326, 174.998914182),
        (-40.2805723867, 175.637724057),
        (-35.848634854, 174.4791339),
        (-39.8683752997, 175.048065485),
        (-43.5315966868, 172.697560325),
        (-45.9408566853, 170.101589276),
        (-37.8705174885, 175.482972172),
        (-43.2130510348, 171.72695799),
        (-45.058988678, 169.189270096),
        (-43.3646092335, 171.528314249),
        (-41.3004852768, 174.769221388),
        (-39.0812151975, 174.086362945),
        (-42.7176377709, 172.876703772),
        (-45.1875207502, 169.310536326),
        (-42.4526724545, 171.301185868),
        (-40.1902762567, 176.030424581),
        (-37.9873733508, 176.830306665),
        (-46.3106884722, 168.777457325),
        (-39.5985368165, 176.761328783),
        (-45.0113569942, 168.741473232),
        (-41.2404125361, 174.916423084),
        (-37.2055485335, 174.736334337),
        (-46.1144805513, 168.912302257),
        (-42.4546012377, 171.214131533),
        (-41.1174664314, 175.437806848),
        (-37.7808418159, 175.306144964),
        (-41.1491739179, 174.978864247),
        (-36.8397025957, 174.618687001),
        (-36.8869494391, 174.660165593),
        (-37.9201771872, 175.765465921),
        (-37.5439649689, 175.152469784),
        (-43.5448398669, 171.982306625),
        (-39.0433768621, 174.236045544),
        (-39.5666886471, 174.310310857),
        (-45.8545215192, 170.474251079),
        (-41.8564968402, 171.953024762),
        (-46.3948155207, 168.393188791),
        (-43.5388319022, 172.511299433),
        (-43.3814646042, 172.638854426),
        (-38.076120811, 176.722276469),
        (-41.6730978361, 172.876035688),
        (-38.2713947594, 175.882947031),
        (-35.3966898147, 173.809927501),
        (-37.9243881109, 175.5365861),
        (-37.1908934823, 175.601774813),
        (-42.6351845264, 171.195248206),
        (-41.2592355796, 174.790179981),
        (-38.1334299616, 175.824471861),
        (-44.9326119245, 170.635950981),
        (-40.4092008259, 175.635549451),
        (-45.5211481446, 167.276414117),
        (-38.1135194993, 176.815016065),
        (-41.7891088006, 172.336058652),
        (-35.8749083288, 174.466832679),
        (-40.5173691736, 175.752494905),
        (-40.5760602727, 175.44864883),
        (-41.2007026233, 174.916971464),
        (-36.9625145645, 174.828088484),
        (-38.9943141868, 174.287898853),
        (-35.7669600808, 174.207945529),
        (-40.9776068289, 175.610760489),
        (-37.677140196, 176.213361715),
        (-40.1030983177, 175.36114196),
        (-36.0864977749, 174.358338264),
        (-39.6595824504, 175.703998282),
        (-46.3073701347, 168.358404146),
        (-39.158318456, 175.399281775),
        (-45.0326937896, 170.092538641),
        (-45.0688535404, 170.917488841),
        (-44.2722195404, 170.052239765),
        (-44.3009704167, 170.113667572),
        (-44.3445823693, 170.179305106),
        (-38.4087260299, 176.086884157),
        (-38.0346829765, 176.337336111),
        (-38.5217954027, 176.294880969),
        (-39.4266047278, 175.368631905),
        (-38.745384598, 175.181245218),
        (-39.3926236832, 173.928042747),
        (-36.9560779526, 174.862172612),
        (-42.831322886, 171.564477285),
        (-38.1299648603, 176.322015635),
        (-36.9254125251, 174.908486668),
        (-36.9060612986, 174.818575162),
        (-41.1091965752, 174.918129263),
        (-40.9249197859, 175.013027936),
        (-39.5509614661, 176.821859618),
        (-36.913526045, 174.726318036),
        (-38.1479453677, 176.226377485),
        (-45.4763883453, 169.319202935),
        (-39.1528527354, 175.837049415),
        (-43.326584125, 172.598955048),
        (-45.8915129198, 170.508085435),
        (-39.3348709226, 174.317998471),
        (-43.63737158, 172.45049085),
        (-41.3136013014, 173.243287011),
        (-44.7315222466, 171.137251757),
        (-36.6226546224, 174.683646562),
        (-36.9274738304, 174.826476106),
        (-37.0387156801, 174.932448283),
        (-37.7269926836, 176.131882506),
        (-44.3728747096, 171.233149093),
        (-44.0137629461, 170.460047233),
        (-44.124139634, 170.213820958),
        (-37.7425658023, 177.685658567),
        (-41.156312553, 174.870972801),
        (-38.9830889033, 175.774331547),
        (-45.8526009352, 170.434949095),
        (-37.816589973, 176.338016967),
        (-44.2240052431, 171.292803176),
        (-38.8904859381, 175.328329643),
        (-38.0029367837, 175.318824556),
        (-39.4671995495, 175.574489528),
        (-38.0755620886, 176.159582637),
        (-38.8063665661, 177.150890652),
        (-46.5827931793, 168.394396178),
        (-44.2776921371, 170.099940871),
        (-41.0990464302, 175.094467652),
        (-38.0254176454, 177.19205314),
        (-40.3153370976, 175.856901342),
        (-36.2840063928, 174.514126075),
        (-37.5665074877, 175.148079052),
        (-39.9388323003, 175.118704796),
        (-39.3842653759, 176.887914708),
        (-37.5686953156, 175.683713629),
        (-41.2613484287, 174.758525518),
        (-36.9882787211, 174.882909973),
        (-38.4204491595, 175.800772871),
        (-37.4158421866, 175.774228513),
        (-41.7175080628, 171.756682715),
        (-38.2915009148, 175.680856721),
        (-43.0524999228, 172.756526411),
        (-41.7511862161, 171.507651096),
        (-39.9191490639, 176.447172807),
        (-38.9971104264, 177.407020996),
        (-38.6242442284, 176.102800205),
        (-44.6924750507, 170.427824364),
        (-39.6072568152, 176.881348354),
        (-39.7541419342, 174.634605252),
        (-36.7648365011, 174.542533004),
        (-37.1249813055, 174.962831197),
        (-37.3166470044, 175.067948128),
        (-37.4795954074, 175.289338172),
        (-37.7279306081, 175.130092523),
        (-37.7419801682, 176.170308394),
        (-38.2515760458, 175.17764437),
        (-41.270589, 174.678531),
        (-42.3165246279, 171.541281246),
        (-44.5644275779, 170.190117567),
        (-41.2994022648, 174.188056536),
        (-42.7245831235, 170.983289791),
        (-36.9733586712, 174.960160682),
        (-44.8867371391, 170.957267678),
        (-44.8878698699, 170.799216641),
        (-36.8454997074, 174.762636226),
        (-38.35603301, 175.745517289),
        (-38.6132790379, 176.184474676),
        (-37.6508136912, 175.560417181),
        (-38.6308840184, 176.04568007),
        (-41.7646051985, 171.611352862),
        (-42.082062895, 171.845416751),
        (-40.3541934307, 175.773821699),
        (-36.7799514789, 174.747205424),
        (-38.4144987541, 175.790203655),
        (-43.4561651395, 172.084365339),
        (-41.2255921691, 174.717470517),
        (-41.29352, 174.63),
        (-41.3153544884, 174.810575319),
        (-41.1515297882, 174.979128442),
        (-44.5709604935, 170.104561025),
        (-37.0314335396, 174.924585834),
        (-43.4926065257, 172.54523532),
        (-38.6180546201, 176.046504909),
        (-39.0947093439, 174.341406914),
        (-39.20881137, 176.68438958),
        (-43.60808618, 172.21575421),
        (-38.6659323, 176.15792422),
        (-40.3515780112181, 175.61885191894),
        (-41.2879319462066, 174.77395442541),
        (-37.8326770813717, 175.301710934626),
        (-43.5390340647917, 172.601318094595),
        (-44.083322, 171.310844),
    ]


def locations_from_csv(locations_filepath) -> List[CodedLocation]:

    locations = []
    locations_filepath = Path(locations_filepath)
    with locations_filepath.open('r') as locations_file:
        reader = csv.reader(locations_file)
        Location = namedtuple("Location", next(reader), rename=True)
        for row in reader:
            location = Location(*row)
            locations.append(
                CodedLocation(lat=float(location.lat), lon=float(location.lon), resolution=0.001)
            )
    return locations


def lat_lon(id):
    return (location_by_id(id)['latitude'], location_by_id(id)['longitude'])

def get_locations(location_names: List[str]) -> List[CodedLocation]:
    """
    given a list of location keys return a list of coded locations. Keys can be any combination of valid
    location_by_id() keys, grid strings, or `lat~lon` location codes.
    """

    locations: List[Tuple[float, float]] = []
    for location_spec in location_names:
        if '~' in location_spec:
            lat, lon = location_spec.split('~')
            locations.append(CodedLocation(float(lat), float(lon), 0.001))
        elif '_intersect_' in location_spec:
            spec0, spec1 = location_spec.split('_intersect_')
            loc0 = set(load_grid(spec0))
            loc1 = set(load_grid(spec1))
            loc01 = list(loc0.intersection(loc1))
            loc01.sort()
            locations += [CodedLocation(*loc, 0.001) for loc in loc01]
        elif '_diff_' in location_spec:
            spec0, spec1 = location_spec.split('_diff_')
            loc0 = set(load_grid(spec0))
            loc1 = set(load_grid(spec1))
            loc01 = list(loc0.difference(loc1))
            loc01.sort()
            locations += [CodedLocation(*loc, 0.001) for loc in loc01]
        elif location_by_id(location_spec):
            locations.append(
                CodedLocation(*lat_lon(location_spec), 0.001)
                )
        elif LOCATION_LISTS.get(location_spec):
            location_ids = LOCATION_LISTS[location_spec]["locations"]
            locations += [CodedLocation(*lat_lon(id),0.001) for id in location_ids]
        elif location_spec == 'TP':
            locations += [CodedLocation(*loc, 0.001,) for loc in transpower_locs()]
        elif Path(location_spec).exists():
            locations += locations_from_csv(location_spec)
        else:
            locations += [CodedLocation(*loc, 0.001) for loc in load_grid(location_spec)]
    return locations